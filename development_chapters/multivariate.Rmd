---
title: "Multivariate Power Analysis"
author: "Aaron R. Caldwell"
date: "9/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(Superpower)
library(tidyverse)
library(knitr)
library(kableExtra)
nsims=10000
```

## Part 6 

### What about sphericity?

In all the above examples, you will notice that the correlation is the sample between repeated measures. For most experiments in real life, this will not be the case. The correlations between levels may vary. This is problematic because the univariate (ANOVA) approach assumes sphericity, which means, for all intents and purposes, that the correlations between factor-levels are equal and the standard deviations at each level are equal as well. This assumption is tenuous at best and is typically "adjusted" for by applying a sphericity correction (e.g, Greenhouse-Geisser). How bad can it get? Well, let's simulate an example below.

```{r }
design_result <- ANOVA_design("4w",
                              n = 29,
                              r = c(.05,.15,.25,.55, .65, .9
                                    ),
                              sd = 1,
                              mu= c(0,0,0,0))

#In order to simulate violations we MUST use ANOVA_power
power_result <- ANOVA_power(design_result, nsims = nsims, verbose = FALSE)

power_result$main_results
```

As we can see, the actual type I error rate far exceeds the typical 5%!

Now, let's pour gasoline on the fire and see what happens when we make the sphericity violation worse by varying the standard deviations.

```{r }
design_result <- ANOVA_design("4w",
                              n = 29,
                              r = c(.05,.15,.25,.55, .65, .9
                                    ),
                              sd = c(1,2,3,4),
                              mu= c(0,0,0,0))

#In order to simulate violations we MUST use ANOVA_power
power_result <- ANOVA_power(design_result, nsims = nsims, verbose = FALSE)

power_result$main_results
```

### MANOVA or Sphericity Adjustment?

While it is tempting to simply say one approach is superior to another, that is not case when the sample size is small (Maxwell and Delaney, ppg 775). Some general guidelines were proposed by Algina and Keselman (1997):

MANOVA when `levels <= 4, epsilon <= .9, n > levels + 15` and `5 <= levels <= 8, epsilon <= .85, n > levels + 30`.

However, `ANOVA_power` can make the solution easy. Simply simulate, like we have done above, for both the null situation (no differences) and with the hypothesized effect (to determine power), and see which approach best balances type I and II error rates.